name: Release

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

    - name: Get short SHA
      id: sha
      run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        {
          echo 'notes<<EOF'
          echo "## What's Changed"
          echo ""
          git log --pretty=format:"* %s (%h)" $(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD 2>/dev/null || git log --pretty=format:"* %s (%h)" -10
          echo ""
          echo ""
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ github.sha }}"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.date.outputs.date }}-${{ steps.sha.outputs.sha }}
        name: Release v${{ steps.date.outputs.date }}-${{ steps.sha.outputs.sha }}
        body: ${{ steps.release_notes.outputs.notes }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
