name: Create Release and Tag

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release and Tag
    runs-on: ubuntu-latest
    # Only run if PR was merged and branch starts with release/
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Extract version from branch name
        id: extract_version
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          # Extract version from branch name (e.g., release/v1.0.1 -> 1.0.1)
          VERSION=$(echo "$BRANCH_NAME" | sed 's/release\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Extract changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Create a temporary file for the changelog content
          CHANGELOG_FILE="CHANGELOG.md"
          OUTPUT_FILE="/tmp/release_notes.md"

          # Escape special regex characters in version for safe pattern matching
          ESCAPED_VERSION=$(echo "$VERSION" | sed 's/[.[\*^$()+?{|]/\\&/g')

          # Check if the version exists in the changelog using literal match
          if ! grep -F "## [$VERSION]" "$CHANGELOG_FILE" > /dev/null; then
            echo "Warning: Version $VERSION not found in CHANGELOG.md"
            echo "Creating a default release note"
            echo "Release $VERSION" > "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            echo "See CHANGELOG.md for details." >> "$OUTPUT_FILE"
          else
            # Extract content between this version and next version
            # Use awk with properly escaped regex pattern
            awk -v ver="$ESCAPED_VERSION" '
              $0 ~ "^## \\[" ver "\\]" {flag=1; next}
              /^## \[/{flag=0}
              /^## Version /{flag=0}
              /^---$/{flag=0}
              flag
            ' "$CHANGELOG_FILE" > "$OUTPUT_FILE"

            # Trim trailing empty lines
            sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' "$OUTPUT_FILE"
          fi

          # Output the changelog for debugging
          echo "Changelog content:"
          cat "$OUTPUT_FILE"

          # Set output - save the file path
          echo "file=$OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: Create Git tag
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          TAG_NAME="v$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and push the tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

          echo "Created and pushed tag: $TAG_NAME"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          TAG_NAME="v$VERSION"
          CHANGELOG_FILE="${{ steps.changelog.outputs.file }}"

          # Create the release using gh CLI
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes-file "$CHANGELOG_FILE" \
            --target main

          echo "Created GitHub release: $TAG_NAME"
